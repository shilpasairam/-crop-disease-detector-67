<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Crop Disease Detector</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #eaf7ea;
  text-align: center;
}
header {
  background: #2e7d32;
  color: white;
  padding: 15px;
  font-size: 22px;
  font-weight: bold;
}
.container {
  padding: 20px;
}
button {
  background: #4caf50;
  color: white;
  border: none;
  padding: 12px 20px;
  margin: 10px;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
}
video {
  width: 280px;
  height: 280px;
  border: 4px solid #2e7d32;
  border-radius: 12px;
  margin-top: 20px;
}
#result {
  font-size: 18px;
  font-weight: bold;
  margin-top: 15px;
  color: #1b5e20;
}
#remedy {
  margin-top: 10px;
  font-size: 15px;
  color: #b71c1c;
}
</style>
</head>

<body>
<header>üå± Crop Disease Detector</header>

<div class="container">
  <p>Place the leaf in front of the camera</p>

  <button onclick="startCamera()">Start Camera</button>
  <button onclick="predict()">Predict</button>

  <br>
  <video id="video" autoplay playsinline muted></video>

  <div id="result">Loading model‚Ä¶</div>
  <div id="remedy"></div>
</div>

<script>
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/i7je_3xwZ/";

let model;
let video = document.getElementById("video");
let history = [];
const STABLE_FRAMES = 6;
const CONFIDENCE = 0.75;

async function loadModel() {
  model = await tmImage.load(
    MODEL_URL + "model.json",
    MODEL_URL + "metadata.json"
  );
  document.getElementById("result").innerText =
    "Model loaded. Tap Start Camera.";
}
loadModel();

async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } },
      audio: false
    });
    video.srcObject = stream;
  } catch (err) {
    // fallback if rear camera exact fails
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio: false
    });
    video.srcObject = stream;
  }
}

async function predict() {
  if (!model || video.readyState !== 4) {
    document.getElementById("result").innerText =
      "Camera not ready. Start camera first.";
    return;
  }

  const prediction = await model.predict(video);
  prediction.sort((a, b) => b.probability - a.probability);

  if (prediction[0].probability < CONFIDENCE) {
    history = [];
    document.getElementById("result").innerText = "Hold leaf steady‚Ä¶";
    document.getElementById("remedy").innerText = "";
    return;
  }

  history.push(prediction[0].className);
  if (history.length > STABLE_FRAMES) history.shift();
  if (!history.every(v => v === history[0])) return;

  const label = prediction[0].className;
  const percent = (prediction[0].probability * 100).toFixed(1);

  document.getElementById("result").innerText =
    `${label} ‚Äî ${percent}%`;

  // Remedies
  if (label.toLowerCase().includes("unhealthy")) {
    document.getElementById("remedy").innerHTML = `
      ‚ö†Ô∏è Possible actions:<br>
      ‚Ä¢ Remove infected leaves<br>
      ‚Ä¢ Avoid over-watering<br>
      ‚Ä¢ Improve sunlight & airflow<br>
      ‚Ä¢ Use organic fungicide / neem oil<br>
      ‚Ä¢ Monitor for 5‚Äì7 days
    `;
  } else {
    document.getElementById("remedy").innerText =
      "‚úÖ Plant appears healthy. Continue regular care.";
  }
}
</script>
</body>
</html>
